parameters:

  - name: targetEnvironment
    displayName: Target Environment
    type: string
    default: development
    values:
      - development
      - test
      - acceptance
      - production

  - name: ObjectId 
    displayName: "Object ID to remove access (Format: xxxx-xxx-xxx-xxx-xxx)"
    type: string

  - name: Scope
    displayName: "Scope to have the access removed (Format: /subscriptions/xxx-xxx-xxx-xxx-xxx/resourceGroups/xxx)"
    type: string

  - name: RoleDefinitionName
    displayName: Name of the Role to be removed (Reader, Contributor, etc)
    type: string


variables:
  - group: Abnamro.Coesd.VariableGroup.GlobalVars 
  - template: ../parameter/global.variables.yml
  - template: ../parameter/${{parameters.targetEnvironment}}.variables.yml  

trigger: none

pr: none

stages:
  # create identities(Service principal and UAMI)
  - stage: RemoveRBACStage
    displayName: Remove RBAC Role

    jobs:

    - job: RemoveRBAC
      displayName: Remove RBAC Role

      steps:

      - task: AzurePowerShell@5
        name: RemoveRBACStep
        displayName: "Remove RBAC Role"
        inputs:
          azurePowerShellVersion: LatestVersion
          azureSubscription: '${{ variables.ResourceGroupName }}'
          ScriptType: InlineScript
          Inline: |

            $ErrorActionPreference = "Stop"

            $ObjectId = "${{ parameters.ObjectId }}"
            $Scope = "${{ parameters.Scope }}"
            $RoleDefinitionName = "${{ parameters.RoleDefinitionName }}"

            Write-Output "ObjectId: $ObjectId"
            Write-Output "Scope: $Scope"
            Write-Output "RoleDefinitionName: $RoleDefinitionName"
        


            # Verify the role assignment exists
            $roleAssignments = Get-AzRoleAssignment -ObjectId $ObjectId -Scope $Scope

            if ($roleAssignments -eq $null) {
                Write-Output "No role assignments found for ObjectId: $ObjectId in Scope: $Scope"
            }

            # Print the role assignments to check the details
            Write-Output "Existing Role Assignments:"
            $roleAssignments | Format-Table -Property RoleDefinitionName, Scope, PrincipalId, PrincipalType -AutoSize -Wrap

            # Confirm the specific role assignment
            $roleAssignment = $roleAssignments | Where-Object {
                $_.RoleDefinitionName -eq $RoleDefinitionName -and
                $_.Scope -eq $Scope
            }

            if ($roleAssignment) {
                Write-Output "Role assignment found. Proceeding to remove $roleAssignment."
                Write-Output "ObjectID: $ObjectId"
                Write-Output "Scope: $Scope"
                Write-Output "RoleDefinitionName: $RoleDefinitionName"
                Try {
                    Remove-AzRoleAssignment -ObjectId $ObjectId -Scope $Scope -RoleDefinitionName $RoleDefinitionName -Verbose -Debug
                    Write-Output "Role assignment removed successfully."
                } Catch {
                    Write-Error "An error occurred while trying to remove the role assignment: $_"
                    Write-Error "Error Details: $($_.Exception.Message)"
                }

            } else {
                Write-Error "Failed to remove role assignment. It does not exist or parameters are incorrect."
            }

YAML pipeline, when run, gives this error:

Starting: Remove RBAC Role
==============================================================================
Task         : Azure PowerShell
Description  : Run a PowerShell script within an Azure environment
Version      : 5.257.0
Author       : Microsoft Corporation
Help         : https://aka.ms/azurepowershelltroubleshooting
==============================================================================
AZUREPS_HOST_ENVIRONMENT: ADO/AzurePowerShell@v5_Linux_Azure Pipelines 3_Remove Role Assignment_13038285__
Generating script.
/usr/bin/pwsh -NoLogo -NoProfile -NonInteractive -ExecutionPolicy Unrestricted -Command . '/home/vsts/work/_temp/5bd89960-4add-4499-9509-be0ccf79de24.ps1'
File saved!
ParserError: /home/vsts/work/_temp/5bd89960-4add-4499-9509-be0ccf79de24.ps1:7
Line |
   7 |  $Scope = ""/subscriptions/1e59c1b9-0d0b-4410-91e5-31b1a7a4929c/resour â€¦
     |              ~
     | You must provide a value expression following the '/' operator.

##[error]PowerShell exited with code '1'.
/usr/bin/pwsh -NoLogo -NoProfile -NonInteractive -ExecutionPolicy Unrestricted -Command . '/home/vsts/work/_tasks/AzurePowerShell_72a1931b-effb-4d2e-8fd8-f8472a07cb62/5.257.0/RemoveAzContext.ps1'
Disconnect-AzAccount -Scope CurrentUser -ErrorAction Stop
Disconnect-AzAccount -Scope Process -ErrorAction Stop
Clear-AzContext -Scope Process -ErrorAction Stop

Finishing: Remove RBAC Role
