$ErrorActionPreference = "Stop"

$ObjectId = ${{ parameters.ObjectId }}
$Scope = ${{ parameters.Scope }}
$RoleDefinitionName = ${{ parameters.RoleDefinitionName }}

Write-Output "ObjectId: $ObjectId"
Write-Output "Scope: $Scope"
Write-Output "RoleDefinitionName: $RoleDefinitionName"

$roleAssignments = Get-AzRoleAssignment -ObjectId $ObjectId | Where-Object {
    $_.RoleDefinitionName -eq $RoleDefinitionName -and $_.Scope -eq $Scope
}

if (-not $roleAssignments) {
    Write-Output "No matching role assignments found."
} else {
    foreach ($assignment in $roleAssignments) {
        Write-Output "Removing RoleAssignmentId: $($assignment.Id)"
        try {
            Remove-AzRoleAssignment -RoleAssignmentId $assignment.Id -Verbose
            Write-Output "Removed successfully."
        } catch {
            Write-Error "Failed to remove role assignment: $_"
        }
    }
}
